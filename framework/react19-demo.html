<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>React19 性能测试</title>
        <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                padding: 20px;
                background: #f5f5f5;
            }
            .header {
                background: #61dafb;
                color: #282c34;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
            }
            .header h1 {
                font-size: 24px;
                margin-bottom: 10px;
            }
            .metrics {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }
            .metric {
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .metric-label {
                font-size: 12px;
                color: #666;
                margin-bottom: 5px;
            }
            .metric-value {
                font-size: 24px;
                font-weight: bold;
                color: #61dafb;
            }
            .controls {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-bottom: 20px;
            }
            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s;
            }
            .btn-primary {
                background: #61dafb;
                color: #282c34;
            }
            .btn-primary:hover {
                background: #4fa8c7;
            }
            .btn-danger {
                background: #e74c3c;
                color: white;
            }
            .btn-danger:hover {
                background: #c0392b;
            }
            .btn-warning {
                background: #f39c12;
                color: white;
            }
            .btn-warning:hover {
                background: #d68910;
            }
            .list-container {
                background: white;
                border-radius: 8px;
                max-height: 400px;
                overflow-y: auto;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .list-item {
                padding: 12px 15px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .list-item:hover {
                background: #f9f9f9;
            }
            .list-item.highlight {
                background: #e3f2fd;
            }
            .item-id {
                font-weight: bold;
                color: #61dafb;
            }
            .item-label {
                flex: 1;
                margin-left: 15px;
            }
            .count-info {
                text-align: center;
                padding: 10px;
                color: #666;
                font-size: 14px;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const adjectives = [
                'pretty',
                'large',
                'big',
                'small',
                'tall',
                'short',
                'long',
                'handsome',
                'plain',
                'quaint',
                'clean',
                'elegant',
                'easy',
                'angry',
                'crazy',
                'helpful',
                'mushy',
                'odd',
                'unsightly',
                'adorable',
                'important',
                'inexpensive',
                'cheap',
                'expensive',
                'fancy'
            ];
            const colours = [
                'red',
                'yellow',
                'blue',
                'green',
                'pink',
                'brown',
                'purple',
                'brown',
                'white',
                'black',
                'orange'
            ];
            const nouns = [
                'table',
                'chair',
                'house',
                'bbq',
                'desk',
                'car',
                'pony',
                'cookie',
                'sandwich',
                'burger',
                'pizza',
                'mouse',
                'keyboard'
            ];

            let idCounter = 1;

            function buildData(count) {
                const data = [];
                for (let i = 0; i < count; i++) {
                    data.push({
                        id: idCounter++,
                        label: `${adjectives[Math.floor(Math.random() * adjectives.length)]} ${
                            colours[Math.floor(Math.random() * colours.length)]
                        } ${nouns[Math.floor(Math.random() * nouns.length)]}`
                    });
                }
                return data;
            }

            // 记录首屏加载时间
            const loadStart = performance.now();

            const {useState, useEffect, useCallback, useMemo, memo} = React;

            // 使用 memo 优化列表项
            const Row = memo(({row, isSelected, onSelect, onRemove}) => (
                <div className={`list-item ${isSelected ? 'highlight' : ''}`} onClick={() => onSelect(row.id)}>
                    <span className='item-id'>{row.id}</span>
                    <span className='item-label'>{row.label}</span>
                    <button
                        className='btn btn-danger'
                        onClick={e => {
                            e.stopPropagation();
                            onRemove(row.id);
                        }}>
                        删除
                    </button>
                </div>
            ));

            function App() {
                const [rows, setRows] = useState([]);
                const [selectedId, setSelectedId] = useState(null);
                const [rowCount, setRowCount] = useState(1000);
                const [metrics, setMetrics] = useState({
                    loadTime: 0,
                    createTime: 0,
                    appendTime: 0,
                    updateTime: 0,
                    swapTime: 0,
                    deleteTime: 0,
                    clearTime: 0
                });

                useEffect(() => {
                    setMetrics(m => ({...m, loadTime: Math.round(performance.now() - loadStart)}));
                }, []);

                const measureTime = useCallback(fn => {
                    return new Promise(resolve => {
                        const start = performance.now();
                        fn();
                        // 使用 requestAnimationFrame 等待渲染完成
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => {
                                resolve(Math.round(performance.now() - start));
                            });
                        });
                    });
                }, []);

                const create = useCallback(
                    async count => {
                        setRowCount(count);
                        const time = await measureTime(() => {
                            setRows(buildData(count));
                        });
                        setMetrics(m => ({...m, createTime: time}));
                    },
                    [measureTime]
                );

                const append = useCallback(
                    async count => {
                        const time = await measureTime(() => {
                            setRows(prev => [...prev, ...buildData(count)]);
                        });
                        setMetrics(m => ({...m, appendTime: time}));
                    },
                    [measureTime]
                );

                const updateEvery10th = useCallback(async () => {
                    const time = await measureTime(() => {
                        setRows(prev =>
                            prev.map((row, i) => (i % 10 === 0 ? {...row, label: row.label + ' !!!'} : row))
                        );
                    });
                    setMetrics(m => ({...m, updateTime: time}));
                }, [measureTime]);

                const swapRows = useCallback(async () => {
                    const time = await measureTime(() => {
                        setRows(prev => {
                            if (prev.length < 999) return prev;
                            const newRows = [...prev];
                            [newRows[1], newRows[998]] = [newRows[998], newRows[1]];
                            return newRows;
                        });
                    });
                    setMetrics(m => ({...m, swapTime: time}));
                }, [measureTime]);

                const select = useCallback(id => {
                    setSelectedId(id);
                }, []);

                const remove = useCallback(
                    async id => {
                        const time = await measureTime(() => {
                            setRows(prev => prev.filter(row => row.id !== id));
                        });
                        setMetrics(m => ({...m, deleteTime: time}));
                    },
                    [measureTime]
                );

                const deleteRow = useCallback(async () => {
                    const time = await measureTime(() => {
                        setRows(prev => prev.slice(1));
                    });
                    setMetrics(m => ({...m, deleteTime: time}));
                }, [measureTime]);

                const clear = useCallback(async () => {
                    const time = await measureTime(() => {
                        setRows([]);
                    });
                    setMetrics(m => ({...m, clearTime: time}));
                }, [measureTime]);

                return (
                    <div>
                        <div className='header'>
                            <h1>⚛️ React 性能测试</h1>
                            <p>测试首屏加载、大量 DOM 渲染、列表更新性能</p>
                        </div>

                        <div className='metrics'>
                            <div className='metric'>
                                <div className='metric-label'>首屏加载时间</div>
                                <div className='metric-value'>{metrics.loadTime} ms</div>
                            </div>
                            <div className='metric'>
                                <div className='metric-label'>创建 {rowCount} 行耗时</div>
                                <div className='metric-value'>{metrics.createTime} ms</div>
                            </div>
                            <div className='metric'>
                                <div className='metric-label'>追加耗时</div>
                                <div className='metric-value'>{metrics.appendTime} ms</div>
                            </div>
                            <div className='metric'>
                                <div className='metric-label'>更新耗时</div>
                                <div className='metric-value'>{metrics.updateTime} ms</div>
                            </div>
                            <div className='metric'>
                                <div className='metric-label'>交换行耗时</div>
                                <div className='metric-value'>{metrics.swapTime} ms</div>
                            </div>
                            <div className='metric'>
                                <div className='metric-label'>删除行耗时</div>
                                <div className='metric-value'>{metrics.deleteTime} ms</div>
                            </div>
                            <div className='metric'>
                                <div className='metric-label'>清空耗时</div>
                                <div className='metric-value'>{metrics.clearTime} ms</div>
                            </div>
                        </div>

                        <div className='controls'>
                            <button className='btn btn-primary' onClick={() => create(1000)}>
                                创建 1,000 行
                            </button>
                            <button className='btn btn-primary' onClick={() => create(10000)}>
                                创建 10,000 行
                            </button>
                            <button className='btn btn-warning' onClick={() => append(1000)}>
                                追加 1,000 行
                            </button>
                            <button className='btn btn-warning' onClick={() => append(5000)}>
                                追加 5,000 行
                            </button>
                            <button className='btn btn-warning' onClick={updateEvery10th}>
                                每10行更新
                            </button>
                            <button className='btn btn-warning' onClick={swapRows}>
                                交换行
                            </button>
                            <button className='btn btn-danger' onClick={deleteRow}>
                                删除第一行
                            </button>
                            <button className='btn btn-danger' onClick={clear}>
                                清空
                            </button>
                        </div>

                        <div className='count-info'>当前行数: {rows.length}</div>

                        <div className='list-container'>
                            {rows.map(row => (
                                <Row
                                    key={row.id}
                                    row={row}
                                    isSelected={row.id === selectedId}
                                    onSelect={select}
                                    onRemove={remove}
                                />
                            ))}
                        </div>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        </script>
    </body>
</html>
