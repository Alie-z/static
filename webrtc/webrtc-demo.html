<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8" />
        <title>WebRTC Prompt åˆ‡æµ Demo</title>
        <style>
            body {
                font-family: sans-serif;
                margin: 20px;
                display: flex;
                gap: 24px;
            }
            video,
            canvas {
                width: 320px;
                height: 180px;
                background: #000;
            }
            #control {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
        </style>
    </head>
    <body>
        <div id="control">
            <input id="prompt" placeholder="è¾“å…¥åœºæ™¯ï¼Œå¦‚ï¼šrainy forest" />
            <button id="switch-camera">åˆ‡æ¢åˆ°æ‘„åƒå¤´</button>
            <button id="switch-canvas">æ ¹æ® Prompt åˆ‡æ¢åˆ°ç”Ÿæˆåœºæ™¯</button>
            <div id="status"></div>
        </div>
        <video id="local" autoplay playsinline muted></video>
        <canvas id="scene" width="640" height="360"></canvas>

        <script>
            const statusEl = document.getElementById('status');
            const localVideo = document.getElementById('local');
            const promptInput = document.getElementById('prompt');
            const sceneCanvas = document.getElementById('scene');
            const ctx = sceneCanvas.getContext('2d');

            // WebRTC ç›¸å…³çš„å…¨å±€å˜é‡ï¼šPeerConnection ä¸å½“å‰ä½¿ç”¨çš„åª’ä½“æµ
            let pc;
            let localStream;
            let canvasStream;
            let animationFrame;
            let promptText = '';

            async function init() {
                // åˆå§‹åŒ– RTCPeerConnectionï¼ˆæ¼”ç¤ºåœºæ™¯æœªåšä¿¡ä»¤äº¤æ¢ï¼Œä»…å±•ç¤ºæœ¬åœ°åˆ‡æ¢é€»è¾‘ï¼‰
                pc = new RTCPeerConnection();
                console.log('ğŸš€ > init > pc:', pc);
                pc.ontrack = ({streams}) => {
                    // çœŸå®ä¸šåŠ¡ä¸­å¯åœ¨æ­¤å°†è¿œç«¯æµæ¸²æŸ“åˆ° <video>
                    console.log('Remote stream arrived', streams[0]);
                };
                // é»˜è®¤è¿›å…¥é¡µé¢ååˆ‡æ¢åˆ°æœ¬åœ°æ‘„åƒå¤´
                await switchToCamera();
            }

            async function switchToCamera() {
                // åœæ‰æ—§çš„æ‘„åƒå¤´æµï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œé˜²æ­¢èµ„æºæ³„éœ²
                stopStream(localStream);
                localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: false});
                // å°†æ‘„åƒå¤´æµæ¨é€ç»™æœ¬åœ°æ’­æ”¾å™¨åŠ PeerConnection
                applyStream(localStream);
                statusEl.textContent = 'å½“å‰è½¨é“ï¼šæ‘„åƒå¤´';
            }

            async function switchToPromptScene() {
                // è®°å½•ç”¨æˆ·è¾“å…¥çš„ promptï¼›ä¸ºç©ºåˆ™ç»™ä¸€ä¸ªé»˜è®¤å€¼
                promptText = promptInput.value.trim() || 'default scene';
                // æ¸…ç†æ—§çš„ canvas æµå¹¶é‡æ–°æ•è·ä¸€ä¸ªæ–°çš„ 30fps æµ
                stopStream(canvasStream);
                canvasStream = sceneCanvas.captureStream(30); // å°† canvas æ¸²æŸ“è¾“å‡ºè½¬æ¢æˆ MediaStream
                startCanvasRender();
                // å°†ç”Ÿæˆåœºæ™¯æµæ¨é€åˆ°æ’­æ”¾å™¨ä¸ PeerConnection
                applyStream(canvasStream);
                statusEl.textContent = `å½“å‰è½¨é“ï¼šPrompt åœºæ™¯ï¼ˆ${promptText}ï¼‰`;
            }

            function applyStream(stream) {
                console.log('ğŸš€ > applyStream > stream:', stream);
                // æŠŠæ–°çš„æµæŒ‚åˆ°æœ¬åœ° <video> ä¸Šï¼Œä¾¿äºåœ¨é¡µé¢ä¸Šå³æ—¶é¢„è§ˆ
                localVideo.srcObject = stream;
                const track = stream.getVideoTracks()[0];

                if (!pc) return;
                // æŸ¥æ‰¾ä¹‹å‰å·²ç»æ·»åŠ è¿‡çš„ video senderï¼Œåç»­ç›´æ¥æ¢è½¨
                const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');

                if (sender) {
                    // ä¸é‡æ–°åå•†ï¼Œç›´æ¥æ›¿æ¢å‘é€è½¨é“ï¼Œå®ç°æ— ç¼åˆ‡æµ
                    sender.replaceTrack(track);
                    sender
                        .setParameters({
                            // æ ¹æ®éœ€è¦è®¾ç½®ç¼–ç å‚æ•°ï¼Œæ­¤å¤„ç¤ºä¾‹é™åˆ¶æœ€å¤§ç ç‡
                            encodings: [{maxBitrate: 1500_000}]
                        })
                        .catch(console.warn);
                    // ä¸»åŠ¨è¯·æ±‚å…³é”®å¸§ï¼Œå‡å°‘è¿œç«¯é»‘å±æ—¶é—´ï¼ˆéƒ¨åˆ†æµè§ˆå™¨æ”¯æŒï¼‰
                    sender.requestKeyFrame?.();
                } else {
                    // é¦–æ¬¡æ¨é€æµæ—¶ï¼Œå°†è½¨é“åŠ å…¥ PeerConnection
                    pc.addTrack(track, stream);
                }
            }

            function stopStream(stream) {
                // åœæ­¢æµä¸­çš„æ‰€æœ‰è½¨é“ï¼Œé‡Šæ”¾æ‘„åƒå¤´æˆ– canvas èµ„æº
                if (!stream) return;
                stream.getTracks().forEach(t => t.stop());
            }

            function startCanvasRender() {
                // è‹¥ä¹‹å‰å·²æœ‰åŠ¨ç”»å¸§å¾ªç¯ï¼Œéœ€è¦å…ˆå–æ¶ˆï¼Œé¿å…é‡å¤æ¸²æŸ“
                cancelAnimationFrame(animationFrame);
                let t = 0;
                (function draw() {
                    // ç®€å•çš„ç¤ºä¾‹ï¼šé€šè¿‡æ”¹å˜ HSL è‰²è°ƒæ¨¡æ‹Ÿä¸€ä¸ªåŠ¨æ€èƒŒæ™¯
                    t += 0.02;
                    ctx.fillStyle = `hsl(${(t * 40) % 360}, 70%, 40%)`;
                    ctx.fillRect(0, 0, sceneCanvas.width, sceneCanvas.height);
                    ctx.fillStyle = '#fff';
                    ctx.font = '28px sans-serif';
                    // åœ¨ç”»é¢ä¸Šå±•ç¤ºå½“å‰ prompt ä¸æ—¶é—´æˆ³
                    ctx.fillText(`Prompt: ${promptText}`, 24, 60);
                    ctx.fillText(`Time: ${(performance.now() / 1000).toFixed(1)}s`, 24, 100);
                    animationFrame = requestAnimationFrame(draw);
                })();
            }

            // ç»‘å®šæŒ‰é’®äº‹ä»¶ï¼šæ‰‹åŠ¨åˆ‡æ‘„åƒå¤´æˆ–æ ¹æ® prompt åˆ‡æ¢åˆ°ç”Ÿæˆåœºæ™¯
            document.getElementById('switch-camera').onclick = switchToCamera;
            document.getElementById('switch-canvas').onclick = switchToPromptScene;

            // å¯åŠ¨ demo
            init();
        </script>
    </body>
</html>
